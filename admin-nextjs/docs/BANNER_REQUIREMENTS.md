# バナー機能 要件定義書

## 📋 目次

- [概要](#概要)
- [機能要件](#機能要件)
- [データモデル](#データモデル)
- [API仕様](#api仕様)
- [UI/UX仕様](#uiux仕様)
- [表示ロジック](#表示ロジック)
- [実装状況](#実装状況)
- [今後の拡張](#今後の拡張)

---

## 概要

### 目的
ECサイトの訪問者に対して、キャンペーン情報、メンテナンス通知、重要なお知らせなどを効果的に伝えるためのバナー表示機能を提供する。

### スコープ
- **管理画面**: バナーの作成・編集・削除・一覧表示
- **フロントエンド**: サイト上でのバナー表示（今後実装予定）
- **スケジューリング**: 予約公開機能による自動表示制御

### 対象ユーザー
- **管理者**: バナーの管理・設定を行う
- **顧客**: サイト訪問時にバナーを閲覧する

---

## 機能要件

### 1. バナー管理機能（管理画面）

#### 1.1 バナー一覧表示

**機能概要**
- 登録されている全バナーを一覧表示
- ステータス・タイプ・公開期間を視覚的に確認可能

**表示項目**
- ステータス（予約中/公開中/期限切れ）
- バナータイプ（情報/成功/警告/エラー）※データとして保持
- ~~メッセージ（本文）~~ **🗑️ 削除予定**
- 画像サムネイル
- 公開開始日時
- 公開終了日時
- 作成日時

> **📝 変更予定**: メッセージ列は一覧から削除されます。バナータイプはデータとして保持しますが、UI上の表示は維持します。

**操作**
- プレビュー: バナーの表示イメージを確認
- 編集: バナー情報を編集（未実装）
- 削除: バナーを削除（確認ダイアログ表示）
- 新規作成: 新しいバナーを作成

**実装状況**: ✅ 完了

---

#### 1.2 バナー作成機能

**機能概要**
- 新しいバナーを作成し、公開スケジュールを設定

**入力項目**

| 項目名 | 必須 | 形式 | 説明 |
|--------|------|------|------|
| ~~メッセージ~~ | ~~✅~~ | ~~テキスト~~ | ~~バナーに表示するメッセージ（最大500文字推奨）~~ **🗑️ 削除予定** |
| ~~バナータイプ~~ | ~~✅~~ | ~~選択~~ | ~~info/success/warning/error~~ **🗑️ 削除予定** |
| バナー画像 | ✅ | 画像ファイル | JPEG/PNG/GIF/WebP、最大5MB、推奨サイズ1200x200px |
| ボタンラベル | ❌ | テキスト | アクションボタンのテキスト |
| リンク先URL | ❌ | URL | アクションボタンのリンク先 |
| 公開開始日時 | ❌ | 日時 | バナー公開開始のタイミング |
| 公開終了日時 | ❌ | 日時 | バナー公開終了のタイミング |

> **📝 変更予定**: メッセージとバナータイプの入力欄を削除します。バナーは画像のみで構成されます。

**バリデーション**
- ~~メッセージ: 空文字禁止~~ **🗑️ 削除予定**
- 画像: 必須、ファイルサイズ5MB以下、対応形式チェック
- ~~バナータイプ: 4種類のいずれか~~ **🗑️ 削除予定**
- 公開日時: 開始日時 < 終了日時

**機能**
- リアルタイムプレビュー: 入力内容を即座にプレビュー表示
- 画像アップロード: ドラッグ&ドロップまたはファイル選択
- 画像プレビュー: アップロード後に画像を確認

**実装状況**: ✅ 完了

---

#### 1.3 バナー編集機能

**機能概要**
- 既存のバナー情報を編集

**機能詳細**
- バナー作成と同じ入力項目（メッセージとバナータイプを除く）
- 既存データをフォームに自動入力

> **📝 変更予定**: メッセージとバナータイプの編集欄を削除します。
- 画像の差し替えが可能

**実装状況**: ❌ 未実装

**優先度**: 🔴 高（次回実装予定）

---

#### 1.4 バナー削除機能

**機能概要**
- 不要になったバナーを削除

**機能詳細**
- 削除前に確認ダイアログを表示
- 削除後は復元不可（物理削除）

**実装状況**: ✅ 完了

---

#### 1.5 バナープレビュー機能

**機能概要**
- バナーの表示イメージを確認

**機能詳細**
- 一覧画面からモーダル形式でプレビュー表示
- 実際の表示と同じスタイルで確認可能
- アクションボタンは動作しない（プレビューのみ）

**実装状況**: ✅ 完了

---

### 2. バナー表示機能（フロントエンド）

#### 2.1 基本表示機能

**機能概要**
- サイト訪問者に対してバナーを表示

**表示条件**
- ステータスが「公開中」のバナーのみ表示
- 現在時刻が公開期間内（開始日時 ≤ 現在 ≤ 終了日時）

**表示位置**
- ヘッダー直下（サイト上部）
- ページ遷移しても継続表示

**表示内容**
- バナー画像（フルサイズ表示、最大高200px）
- メッセージテキスト
- アイコン（バナータイプに応じた）
- アクションボタン（設定されている場合）

**実装状況**: ❌ 未実装

**優先度**: 🟡 中

---

#### 2.2 複数バナー表示制御

**機能概要**
- 複数のバナーが公開中の場合の表示制御

**表示ルール**（今後検討）
- オプション1: 全て表示（縦に並べる）
- オプション2: 最新のみ表示
- オプション3: 優先度順に表示
- オプション4: カルーセル表示

**実装状況**: ❌ 未実装

**優先度**: 🟢 低（将来拡張）

---

#### 2.3 表示条件管理

**機能概要**
- バナーの表示条件を細かく設定

**条件項目**（今後検討）
- URL条件: 特定のページでのみ表示
- デバイス条件: PC/モバイルで表示切替
- ユーザー条件: ログイン状態、会員ランクなど
- 地域条件: IPアドレスベースの地域判定

**実装状況**: ❌ 未実装

**優先度**: 🟢 低（将来拡張）

---

### 3. スケジューリング機能

#### 3.1 予約公開機能

**機能概要**
- 指定した日時に自動的にバナーを公開・非公開

**動作**
- 公開開始日時が設定されている場合:
  - 現在時刻 < 開始日時 → ステータス「予約中」（非表示）
  - 現在時刻 ≥ 開始日時 → ステータス「公開中」（表示）
- 公開終了日時が設定されている場合:
  - 現在時刻 > 終了日時 → ステータス「期限切れ」（非表示）
- 日時未設定の場合:
  - 常時「公開中」として扱う

**ステータス判定ロジック**
```typescript
if (publishStartDate && now < publishStartDate) {
  return 'scheduled'; // 予約中
}
if (publishEndDate && now > publishEndDate) {
  return 'expired'; // 期限切れ
}
return 'active'; // 公開中
```

**実装状況**: ✅ 完了

---

### 4. 画像管理機能

#### 4.1 画像アップロード

**機能概要**
- バナー画像をアップロードして保存

**対応形式**
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- WebP (.webp)

**制限**
- ファイルサイズ: 最大5MB
- 推奨サイズ: 1200x200px（横長）
- 最小サイズ: 800x100px
- 最大サイズ: 2400x400px

**機能**
- ドラッグ&ドロップ対応
- ファイル選択ダイアログ
- アップロード後のプレビュー表示
- 画像の差し替え・削除

**保存先**
- ディレクトリ: `/public/uploads/`
- ファイル名: `{uuid}.{拡張子}`

**実装状況**: ✅ 完了

---

## データモデル

### BannerConfig

バナー情報を格納するデータモデル

```typescript
interface BannerConfig {
  // 基本情報
  id: string;                      // バナーID（UUID v4）
  message: string;                 // メッセージ本文（🗑️ 削除予定だがデータとして保持）
  variant: BannerVariant;          // バナータイプ（データとして保持、UIから入力不可）
  imageUrl: string;                // 画像URL（必須）

  // アクションボタン（任意）
  actionLabel?: string;            // ボタンラベル
  actionUrl?: string;              // リンク先URL

  // 公開スケジュール（任意）
  publishStartDate?: string;       // 公開開始日時（ISO 8601形式）
  publishEndDate?: string;         // 公開終了日時（ISO 8601形式）

  // メタデータ
  createdAt: string;               // 作成日時（ISO 8601形式）
  updatedAt: string;               // 更新日時（ISO 8601形式）
}

type BannerVariant = 'info' | 'success' | 'warning' | 'error';
```

> **📝 データ構造の変更方針**:
> - `message`と`variant`はフィールドとして保持しますが、UI上の入力欄を削除します
> - 既存データとの互換性を保つため、データ構造自体は変更しません
> - 新規作成時は`message: ''`、`variant: 'info'`のデフォルト値で保存します

### BannerStatus

バナーの公開ステータス（算出値）

```typescript
type BannerStatus = 'scheduled' | 'active' | 'expired';

// scheduled: 予約中（公開前）
// active: 公開中
// expired: 期限切れ（公開終了）
```

---

## API仕様

### エンドポイント一覧

| メソッド | パス | 説明 | 実装状況 |
|---------|------|------|----------|
| GET | `/api/settings/banners` | バナー一覧取得 | ✅ 完了 |
| POST | `/api/settings/banners` | バナー作成 | ✅ 完了 |
| GET | `/api/settings/banners/[id]` | バナー詳細取得 | ✅ 完了 |
| PUT | `/api/settings/banners/[id]` | バナー更新（全体） | ✅ 完了 |
| PATCH | `/api/settings/banners/[id]` | バナー更新（部分） | ✅ 完了 |
| DELETE | `/api/settings/banners/[id]` | バナー削除 | ✅ 完了 |

---

### GET `/api/settings/banners`

**説明**: 登録されている全バナーを取得

**リクエスト**
```
GET /api/settings/banners
```

**レスポンス**
```json
{
  "success": true,
  "data": [
    {
      "id": "banner-001",
      "message": "春の大セール開催中！",
      "variant": "success",
      "imageUrl": "https://example.com/banner.jpg",
      "actionLabel": "詳細を見る",
      "actionUrl": "https://example.com/sale",
      "publishStartDate": "2025-03-01T00:00:00.000Z",
      "publishEndDate": "2025-03-31T23:59:59.000Z",
      "createdAt": "2025-01-15T10:00:00.000Z",
      "updatedAt": "2025-01-15T10:00:00.000Z"
    }
  ]
}
```

**エラーレスポンス**
```json
{
  "success": false,
  "message": "サーバーエラーが発生しました"
}
```

---

### POST `/api/settings/banners`

**説明**: 新しいバナーを作成

**リクエスト**
```json
{
  "message": "春の大セール開催中！",
  "variant": "success",
  "imageUrl": "/uploads/abc123.jpg",
  "actionLabel": "詳細を見る",
  "actionUrl": "https://example.com/sale",
  "publishStartDate": "2025-03-01T00:00:00.000Z",
  "publishEndDate": "2025-03-31T23:59:59.000Z"
}
```

**バリデーション**
- `message`: 必須、文字列
- `variant`: 必須、`info`/`success`/`warning`/`error` のいずれか
- `imageUrl`: 必須、文字列
- `publishStartDate` < `publishEndDate` （両方設定されている場合）

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "id": "banner-001",
    "message": "春の大セール開催中！",
    "variant": "success",
    "imageUrl": "/uploads/abc123.jpg",
    "actionLabel": "詳細を見る",
    "actionUrl": "https://example.com/sale",
    "publishStartDate": "2025-03-01T00:00:00.000Z",
    "publishEndDate": "2025-03-31T23:59:59.000Z",
    "createdAt": "2025-10-09T12:00:00.000Z",
    "updatedAt": "2025-10-09T12:00:00.000Z"
  }
}
```

**エラーレスポンス**
```json
{
  "success": false,
  "message": "メッセージは必須です"
}
```

---

### GET `/api/settings/banners/[id]`

**説明**: 特定のバナー情報を取得

**リクエスト**
```
GET /api/settings/banners/banner-001
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "id": "banner-001",
    "message": "春の大セール開催中！",
    "variant": "success",
    "imageUrl": "/uploads/abc123.jpg",
    "actionLabel": "詳細を見る",
    "actionUrl": "https://example.com/sale",
    "publishStartDate": "2025-03-01T00:00:00.000Z",
    "publishEndDate": "2025-03-31T23:59:59.000Z",
    "createdAt": "2025-01-15T10:00:00.000Z",
    "updatedAt": "2025-01-15T10:00:00.000Z"
  }
}
```

**エラーレスポンス（404）**
```json
{
  "success": false,
  "message": "バナーが見つかりません"
}
```

---

### PUT `/api/settings/banners/[id]`

**説明**: バナー情報を更新（全項目を上書き）

**リクエスト**
```json
{
  "message": "春の大セール開催中！全商品30%OFF",
  "variant": "success",
  "imageUrl": "/uploads/def456.jpg",
  "actionLabel": "今すぐ購入",
  "actionUrl": "https://example.com/sale",
  "publishStartDate": "2025-03-01T00:00:00.000Z",
  "publishEndDate": "2025-03-31T23:59:59.000Z"
}
```

**バリデーション**
- POST と同じバリデーションルール

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "id": "banner-001",
    "message": "春の大セール開催中！全商品30%OFF",
    "variant": "success",
    "imageUrl": "/uploads/def456.jpg",
    "actionLabel": "今すぐ購入",
    "actionUrl": "https://example.com/sale",
    "publishStartDate": "2025-03-01T00:00:00.000Z",
    "publishEndDate": "2025-03-31T23:59:59.000Z",
    "createdAt": "2025-01-15T10:00:00.000Z",
    "updatedAt": "2025-10-09T12:30:00.000Z"
  }
}
```

---

### PATCH `/api/settings/banners/[id]`

**説明**: バナー情報を部分更新（指定した項目のみ更新）

**リクエスト例**
```json
{
  "message": "春の大セール開催中！全商品30%OFF"
}
```

**レスポンス（成功）**
```json
{
  "success": true,
  "data": {
    "id": "banner-001",
    "message": "春の大セール開催中！全商品30%OFF",
    "variant": "success",
    "imageUrl": "/uploads/abc123.jpg",
    "actionLabel": "詳細を見る",
    "actionUrl": "https://example.com/sale",
    "publishStartDate": "2025-03-01T00:00:00.000Z",
    "publishEndDate": "2025-03-31T23:59:59.000Z",
    "createdAt": "2025-01-15T10:00:00.000Z",
    "updatedAt": "2025-10-09T12:35:00.000Z"
  }
}
```

---

### DELETE `/api/settings/banners/[id]`

**説明**: バナーを削除

**リクエスト**
```
DELETE /api/settings/banners/banner-001
```

**レスポンス（成功）**
```json
{
  "success": true,
  "message": "バナーを削除しました"
}
```

**エラーレスポンス（404）**
```json
{
  "success": false,
  "message": "バナーが見つかりません"
}
```

---

### POST `/api/upload`

**説明**: 画像ファイルをアップロード

**リクエスト**
```
POST /api/upload
Content-Type: multipart/form-data

file: [画像ファイル]
```

**バリデーション**
- ファイルサイズ: 5MB以下
- ファイル形式: JPEG/PNG/GIF/WebP

**レスポンス（成功）**
```json
{
  "success": true,
  "url": "/uploads/abc123-def456-ghi789.jpg"
}
```

**エラーレスポンス**
```json
{
  "success": false,
  "message": "ファイルサイズは5MB以下にしてください"
}
```

---

## UI/UX仕様

### 1. バナーコンポーネント

#### デザイン仕様

**バナータイプ別のカラースキーム**

| タイプ | 背景色 | ボーダー色 | テキスト色 | アイコン |
|--------|--------|-----------|-----------|---------|
| info | `bg-blue-50` | `border-blue-200` | `text-blue-900` | info |
| success | `bg-green-50` | `border-green-200` | `text-green-900` | check |
| warning | `bg-yellow-50` | `border-yellow-200` | `text-yellow-900` | alert |
| error | `bg-red-50` | `border-red-200` | `text-red-900` | close |

**レイアウト**
```
┌─────────────────────────────────────────────┐
│  [バナー画像]                               │
│  （フル幅、最大高200px）                    │
├─────────────────────────────────────────────┤
│  [アイコン] メッセージテキスト  [ボタン]   │
│  （padding: 12px 16px）                     │
└─────────────────────────────────────────────┘
```

**画像表示**
- 幅: 100%（コンテナ幅に合わせる）
- 高さ: auto（アスペクト比を維持）
- 最大高: 200px
- object-fit: cover（はみ出た部分をトリミング）

**メッセージ表示**
- フォントサイズ: 14px
- フォントウェイト: 500（medium）
- 行の高さ: 1.5

**アクションボタン**
- スタイル: テキストリンク（下線あり）
- ホバー: 下線を削除
- フォントサイズ: 14px
- フォントウェイト: 600（semibold）

---

### 2. 管理画面UI

#### 2.1 バナー一覧画面

**レイアウト**
- ヘッダー: タイトル + 新規作成ボタン
- テーブル形式での一覧表示
- カラム: ステータス、タイプ、メッセージ、画像、作成日、アクション

**ステータスバッジ**
- 予約中: 黄色（warning）
- 公開中: 緑色（success）
- 期限切れ: グレー（default）

**アクションボタン**
- プレビュー: 青色（secondary）
- 編集: 青色（secondary）
- 削除: 赤色（error）

---

#### 2.2 バナー作成/編集画面

**レイアウト**
- ヘッダー: タイトル
- プレビューセクション（折りたたみ可能）
- フォームセクション
  - バナータイプ選択
  - メッセージ入力
  - 画像アップロード
  - アクションボタン設定（オプション）
  - 予約公開設定（オプション）
- フッター: キャンセル、プレビュー、保存ボタン

**フォーム項目のグルーピング**
```
┌─ 基本設定 ─────────────────┐
│ バナータイプ              │
│ メッセージ                │
│ バナー画像（必須）        │
└───────────────────────────┘

┌─ アクションボタン（任意）──┐
│ ボタンラベル              │
│ リンク先URL               │
└───────────────────────────┘

┌─ 予約公開設定 ─────────────┐
│ 公開開始日時              │
│ 公開終了日時              │
└───────────────────────────┘
```

---

## 表示ロジック

### 1. ステータス判定

```typescript
function getBannerStatus(banner: BannerConfig): BannerStatus {
  const now = new Date();

  // 開始日時チェック
  if (banner.publishStartDate) {
    const startDate = new Date(banner.publishStartDate);
    if (now < startDate) {
      return 'scheduled'; // 予約中
    }
  }

  // 終了日時チェック
  if (banner.publishEndDate) {
    const endDate = new Date(banner.publishEndDate);
    if (now > endDate) {
      return 'expired'; // 期限切れ
    }
  }

  return 'active'; // 公開中
}
```

### 2. フロントエンド表示判定

```typescript
function shouldDisplayBanner(banner: BannerConfig): boolean {
  const status = getBannerStatus(banner);
  return status === 'active'; // 公開中のバナーのみ表示
}
```

### 3. 表示バナーの取得

```typescript
async function getActiveBanners(): Promise<BannerConfig[]> {
  const response = await fetch('/api/settings/banners');
  const data = await response.json();

  if (!data.success) {
    return [];
  }

  // 公開中のバナーのみフィルタリング
  return data.data.filter(shouldDisplayBanner);
}
```

---

## 実装状況

### ✅ 完了している機能

| カテゴリ | 機能 | 実装日 |
|---------|------|--------|
| 管理画面 | バナー一覧表示 | 2025-10-09 |
| 管理画面 | バナー作成 | 2025-10-09 |
| 管理画面 | バナー削除 | 2025-10-09 |
| 管理画面 | バナープレビュー | 2025-10-09 |
| API | 全エンドポイント | 2025-10-09 |
| スケジューリング | 予約公開機能 | 2025-10-09 |
| スケジューリング | ステータス自動判定 | 2025-10-09 |
| 画像管理 | 画像アップロード | 2025-10-09 |
| バリデーション | 入力チェック | 2025-10-09 |
| バリデーション | 日付論理チェック | 2025-10-09 |

### ❌ 未実装の機能

| カテゴリ | 機能 | 優先度 | 予定 |
|---------|------|--------|------|
| 管理画面 | バナー編集画面 | 🔴 高 | Phase 2 |
| 管理画面 | 表示順序管理 | 🟡 中 | Phase 3 |
| 管理画面 | 一括操作 | 🟢 低 | 未定 |
| 管理画面 | 検索・フィルタ | 🟢 低 | 未定 |
| フロントエンド | バナー表示機能 | 🟡 中 | Phase 3 |
| フロントエンド | 複数バナー制御 | 🟢 低 | Phase 4 |
| フロントエンド | 表示条件管理 | 🟢 低 | Phase 4 |
| 拡張機能 | クリック計測 | 🟢 低 | 未定 |
| 拡張機能 | A/Bテスト | 🟢 低 | 未定 |

---

## 今後の拡張

### Phase 2: 必須機能の実装

**目標**: 管理画面の基本機能を完成させる

1. **バナー編集画面の実装**
   - 既存バナーの編集フォーム
   - 画像の差し替え機能
   - 変更履歴の保存

2. **型定義の共通化**
   - `BannerConfig` を共通の型定義ファイルに移動
   - インポートパスの統一

3. **Bannerコンポーネントのリファクタリング**
   - 不要なプロパティ（`dismissible`, `showImage`）の削除
   - プロパティの必須化（`imageUrl`）

---

### Phase 3: フロントエンド実装

**目標**: 顧客向けのバナー表示機能を実装

1. **基本表示機能**
   - ヘッダー直下へのバナー配置
   - 公開中バナーの自動表示
   - レスポンシブ対応

2. **表示順序管理**
   - バナーに優先度フィールドを追加
   - 管理画面で順序を設定可能に
   - 優先度順にバナーを表示

3. **複数バナー表示**
   - 複数バナーの表示方法を選択
   - カルーセル表示の実装（検討）

---

### Phase 4: 高度な機能

**目標**: マーケティングに活用できる高度な機能を追加

1. **表示条件管理**
   - URL条件による表示制御
   - デバイス種別での出し分け
   - ユーザー属性での出し分け

2. **分析機能**
   - バナー表示回数の計測
   - クリック率の計測
   - コンバージョン追跡

3. **テンプレート機能**
   - 定型バナーのテンプレート作成
   - テンプレートからの簡単作成

4. **A/Bテスト**
   - 複数バナーの効果測定
   - 自動最適化

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-10-09 | 1.0.0 | 初版作成 |

---

**文書管理**
- **作成者**: 開発チーム
- **最終更新**: 2025-10-09
- **次回レビュー**: Phase 2 実装前
